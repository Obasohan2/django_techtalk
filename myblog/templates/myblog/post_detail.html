{% extends "myblog/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <div class="card mb-4 shadow">
    <div class="card-body">
      <h3 class="card-title">{{ post.title }}</h3>
      <p class="text-muted">Posted by <a href="{% url 'user_profile' post.author.username %}">{{ post.author.username }}</a></p>
      <p class="text-muted">
        Posted by {{ post.author.username }} on {{ post.created_on|date:"M d, Y H:i" }} 
        in <strong>{{ post.category }}</strong>
      </p>
      {% if post.image %}
        <img src="{{ post.image.url }}" alt="{{ post.title }}" class="img-fluid mb-3">
      {% endif %}
      <div class="card-text">
        {{ post.content|linebreaks }}
      </div>

      <!-- Like button -->
      {% if user.is_authenticated %}
        <button id="like-button" data-post-id="{{ post.id }}" class="btn btn-outline-danger like-btn {% if has_liked %}liked{% endif %}">
          <span id="like-icon">{% if has_liked %}❤️{% else %}♡{% endif %}</span>
          <span id="likes-count">{{ post.total_likes }}</span>
        </button>
      {% else %}
        <p class="mt-3 text-muted">Login to like this post.</p>
      {% endif %}
    </div>
  </div>

  <!-- Comments -->
  <div class="card mb-4 shadow">
    <div class="card-header bg-light">
      <h5 class="mb-0">Comments ({{ post.comments.count }})</h5>
    </div>
    <div class="card-body">
      {% for comment in comments %}
        <div class="mb-3">
          <strong>{{ comment.author.username }}</strong> on {{ comment.created_on|date:"M d, Y H:i" }}:
          <p>{{ comment.content }}</p>
          {% if user.is_authenticated %}
            <!-- Reply button -->
            <a href="#" class="btn btn-sm btn-link text-primary reply-btn" data-id="{{ comment.id }}">Reply</a>
            <!-- Reply form -->
            <form method="post" class="reply-form mt-2 d-none" id="reply-form-{{ comment.id }}">
              {% csrf_token %}
              {{ comment_form.as_p }}
              <input type="hidden" name="parent_id" value="{{ comment.id }}">
              <button type="submit" class="btn btn-sm btn-success">Submit Reply</button>
            </form>
          {% endif %}

          {% for reply in comment.children.all %}
            <div class="ms-4 mt-2 p-2 bg-light border rounded">
              <strong>{{ reply.author.username }}</strong> replied:
              <p class="mb-1">{{ reply.content }}</p>
              <small class="text-muted">{{ reply.created_on|date:"M d, Y H:i" }}</small>
            </div>
          {% endfor %}
        </div>
        <hr>
      {% empty %}
        <p>No comments yet.</p>
      {% endfor %}
    </div>
  </div>

  <!-- Add a comment -->
  <div class="card shadow">
    <div class="card-header bg-light">
      <h5 class="mb-0">Leave a Comment</h5>
    </div>
    <div class="card-body">
      {% if user.is_authenticated %}
        <form method="post">
          {% csrf_token %}
          {{ comment_form.as_p }}
          <button type="submit" class="btn btn-primary">Submit</button>
        </form>
      {% else %}
        <p>Please <a href="{% url 'login' %}?next={{ request.path }}">login</a> to comment.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- jQuery (for AJAX) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Like AJAX -->
<script>
  $(document).ready(function () {
    $('#like-button').click(function () {
      const btn = $(this);
      const postId = btn.data('post-id');

      $.ajax({
        url: "{% url 'toggle_like' %}",
        type: "POST",
        data: {
          'post_id': postId,
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function (response) {
          if (response.liked) {
            btn.addClass('liked');
            $('#like-icon').text('❤️');
          } else {
            btn.removeClass('liked');
            $('#like-icon').text('♡');
          }
          $('#likes-count').text(response.likes_count);
        },
        error: function () {
          alert("Something went wrong!");
        }
      });
    });

    // Reply button toggle
    $(".reply-btn").click(function (e) {
      e.preventDefault();
      const id = $(this).data("id");
      $("#reply-form-" + id).toggleClass("d-none");
    });
  });
</script>
{% endblock %}